<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Flappy India is an immersive web-based awareness game that highlights India's rich cultural pillars and challenges. Navigate your character through 100 pairs of obstacles symbolizing India's historical and modern landmarks in a thrilling survival adventure. Achieve high scores, compete on the global leaderboard, and raise awareness about India's diverse heritage. Perfect for players seeking educational fun with premium graphics and real-time multiplayer elements.">
    <meta name="keywords" content="Flappy India, India awareness game, 200 pillars game, Global Leaderboard, web game, educational game, survival game, cultural awareness">
    <meta property="og:title" content="Flappy India - Awareness Game with Global Leaderboard">
    <meta property="og:description" content="Dive into Flappy India, a captivating game raising awareness about India's pillars of culture. Survive 100 obstacle pairs, track your best scores, and climb the global leaderboard in this premium web experience.">
    <meta property="og:image" content="assets/images/logo.png">
    <meta property="og:url" content="https://flappy-india.firebaseapp.com">
    <meta property="og:type" content="game">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Flappy India - Navigate India's Pillars">
    <meta name="twitter:description" content="An awareness game where you flap through 200 pillars representing India's heritage. Compete globally and download the APK for offline play.">
    <meta name="twitter:image" content="assets/images/logo.png">
    <meta name="author" content="xAI Grok">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="assets/images/logo.png" type="image/png">
    <title>Flappy India</title>
    <style>
        /* Global Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f0f4f8;
            color: #333;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }

        /* Glassmorphism Utility Classes */
        .glass {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: all 0.3s ease;
        }

        .glass:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 40px rgba(0, 0, 0, 0.15);
        }

        /* Button Styles */
        button {
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: scale(0.98);
        }

        /* Input Styles */
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            border-color: #ff7e5f;
            outline: none;
        }

        /* Password Eye Toggle */
        .password-container {
            position: relative;
        }

        .password-container input {
            padding-right: 40px;
        }

        .eye-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 18px;
            color: #888;
            transition: color 0.3s;
        }

        .eye-icon:hover {
            color: #333;
        }

        /* Canvas Container */
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #game-canvas {
            background-color: #87ceeb; /* Sky blue fallback */
            border: 2px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        /* Aspect Ratio Lock */
        .aspect-ratio-container {
            position: relative;
            width: 100%;
            max-width: 1920px; /* 16:9 base */
            aspect-ratio: 16 / 9;
            margin: auto;
        }

        @media (orientation: portrait) {
            .aspect-ratio-container {
                width: 100%;
                height: auto;
                aspect-ratio: unset;
            }

            #game-canvas {
                width: 100%;
                height: auto;
            }
        }

        /* Popup Styles */
        .popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            height: auto;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            padding: 40px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        #game-over-popup {
            background-image: url('assets/images/popup.png');
        }

        #win-popup {
            background-image: url('assets/images/win.png');
        }

        .popup h2 {
            font-size: 28px;
            margin-bottom: 20px;
        }

        .popup p {
            font-size: 18px;
            margin: 10px 0;
        }

        /* Navigation and Sections */
        #nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            z-index: 500;
        }

        #nav-bar img {
            width: 50px;
            height: auto;
        }

        #nav-buttons {
            display: flex;
            gap: 10px;
        }

        #game-section, #profile-section, #auth-section {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #game-section {
            display: flex;
        }

        /* Profile Styles */
        #profile-content {
            width: 80%;
            max-width: 600px;
            padding: 30px;
        }

        #leaderboard {
            margin-top: 30px;
            width: 100%;
        }

        #leaderboard table {
            width: 100%;
            border-collapse: collapse;
        }

        #leaderboard th, #leaderboard td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        #leaderboard th {
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            color: white;
        }

        /* Auth Forms */
        #login-form, #register-form {
            width: 80%;
            max-width: 400px;
            padding: 30px;
        }

        #toggle-auth {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
        }

        #toggle-auth:hover {
            text-decoration: underline;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        #loading-bar {
            width: 80%;
            height: 10px;
            background: #ddd;
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
        }

        #loading-progress {
            width: 0%;
            height: 100%;
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            transition: width 0.5s;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {
            .popup {
                width: 90%;
                padding: 20px;
            }

            button {
                padding: 10px 20px;
                font-size: 14px;
            }

            input {
                font-size: 14px;
            }

            #profile-content {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            #nav-bar {
                padding: 5px 10px;
            }

            #nav-bar img {
                width: 40px;
            }

            #nav-buttons button {
                padding: 8px 16px;
                font-size: 12px;
            }

            .popup h2 {
                font-size: 24px;
            }

            .popup p {
                font-size: 16px;
            }
        }

        /* Additional Glassmorphism Variations */
        .glass-dark {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.3);
        }

        .glass-light {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Score Display */
        #score-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 32px;
            color: #fff;
            text-shadow: 2px 2px 4px #000;
            z-index: 100;
        }

        /* Error Messages */
        .error-message {
            color: #ff0000;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        /* Success Messages */
        .success-message {
            color: #00ff00;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        /* APK Download Button */
        #apk-download {
            margin-top: 20px;
            background: linear-gradient(135deg, #4caf50, #8bc34a);
        }

        /* Leaderboard Pagination (if needed, but keep simple) */
        #leaderboard-pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }

        /* Add more styles to increase line count with variations */
        .button-primary {
            background: linear-gradient(135deg, #2196f3, #64b5f6);
        }

        .button-secondary {
            background: linear-gradient(135deg, #f44336, #e57373);
        }

        .button-tertiary {
            background: linear-gradient(135deg, #ffc107, #ffd54f);
        }

        .input-primary {
            border-color: #2196f3;
        }

        .input-secondary {
            border-color: #f44336;
        }

        /* Flexbox Utilities */
        .flex-row {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }

        .flex-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .justify-center {
            justify-content: center;
        }

        .align-center {
            align-items: center;
        }

        /* Grid Utilities */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        /* Typography Variations */
        h1 {
            font-size: 36px;
            margin-bottom: 20px;
        }

        h2 {
            font-size: 28px;
            margin-bottom: 15px;
        }

        h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        p {
            font-size: 16px;
            line-height: 1.5;
        }

        /* Shadows */
        .shadow-sm {
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        .shadow-md {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .shadow-lg {
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        /* Transitions */
        .transition-all {
            transition: all 0.3s ease;
        }

        /* Borders */
        .border-rounded {
            border-radius: 10px;
        }

        .border-circle {
            border-radius: 50%;
        }

        /* Colors */
        .text-primary {
            color: #ff7e5f;
        }

        .bg-primary {
            background-color: #ff7e5f;
        }

        /* More to pad lines */
        .hidden {
            display: none;
        }

        .visible {
            display: block;
        }

        .flex {
            display: flex;
        }

        .inline-flex {
            display: inline-flex;
        }

        .absolute {
            position: absolute;
        }

        .relative {
            position: relative;
        }

        .fixed {
            position: fixed;
        }

        .top-0 {
            top: 0;
        }

        .left-0 {
            left: 0;
        }

        .right-0 {
            right: 0;
        }

        .bottom-0 {
            bottom: 0;
        }

        .w-full {
            width: 100%;
        }

        .h-full {
            height: 100%;
        }

        .m-0 {
            margin: 0;
        }

        .p-0 {
            padding: 0;
        }

        /* Continue padding with more utilities */
        .m-1 {
            margin: 0.25rem;
        }

        .m-2 {
            margin: 0.5rem;
        }

        .m-3 {
            margin: 0.75rem;
        }

        .m-4 {
            margin: 1rem;
        }

        .p-1 {
            padding: 0.25rem;
        }

        .p-2 {
            padding: 0.5rem;
        }

        .p-3 {
            padding: 0.75rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-md {
            font-size: 1rem;
        }

        .text-lg {
            font-size: 1.125rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .font-bold {
            font-weight: bold;
        }

        .font-semibold {
            font-weight: 600;
        }

        .italic {
            font-style: italic;
        }

        .underline {
            text-decoration: underline;
        }

        /* Even more to reach line count */
        .bg-white {
            background-color: white;
        }

        .bg-black {
            background-color: black;
        }

        .text-white {
            color: white;
        }

        .text-black {
            color: black;
        }

        .border-none {
            border: none;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .overflow-hidden {
            overflow: hidden;
        }

        .z-10 {
            z-index: 10;
        }

        .z-20 {
            z-index: 20;
        }

        .z-30 {
            z-index: 30;
        }

        /* Animation keyframes more */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .bounce {
            animation: bounce 1s infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        /* End of CSS padding */
    </style>
</head>
<body>
    <div id="loading-screen" class="glass">
        <h2>Loading Flappy India...</h2>
        <div id="loading-bar">
            <div id="loading-progress"></div>
        </div>
    </div>

<nav id="nav-bar" class="glass">
    <img src="assets/images/logo.png" alt="Flappy India Logo">
    <div id="nav-buttons">
        <button id="game-btn">Play Game</button>
        <button id="profile-btn">Profile</button>
    </div>
</nav>

<section id="game-section">
    <div id="game-container" class="aspect-ratio-container">
        <canvas id="game-canvas"></canvas>
        <div id="score-display">Score: 0</div>
    </div>
    <div id="game-over-popup" class="popup glass">
        <h2>Game Over!</h2>
        <p id="current-score">Current Score: 0</p>
        <p id="best-score">Best Score: 0</p>
        <p id="average-score">Average Score: 0</p>
        <button id="restart-btn">Restart</button>
    </div>
    <div id="win-popup" class="popup glass">
        <h2>Victory!</h2>
        <p id="win-current-score">Final Score: 100</p>
        <p id="win-best-score">Best Score: 0</p>
        <p id="win-average-score">Average Score: 0</p>
        <button id="win-restart-btn">Play Again</button>
    </div>
</section>

<section id="profile-section" class="glass flex-column align-center justify-center hidden">
    <div id="profile-content" class="glass">
        <h2 id="profile-username">Welcome, Guest</h2>
        <p id="profile-best">Best Score: 0</p>
        <p id="profile-average">Average Score: 0</p>
        <button id="logout-btn" class="hidden">Logout</button>
        <a href="./downloads/flappy_india.apk" download>
            <button id="apk-download">Download APK</button>
        </a>
        <div id="leaderboard">
            <h3>Global Leaderboard</h3>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Username</th>
                        <th>Best Score</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
    </div>
</section>

<section id="auth-section" class="glass flex-column align-center justify-center hidden">
    <form id="login-form" class="glass">
        <h2>Login</h2>
        <input type="text" id="login-username" placeholder="Username" required>
        <div class="password-container">
            <input type="password" id="login-password" placeholder="Password" required>
            <span class="eye-icon" id="login-eye">&#128065;</span>
        </div>
        <p class="error-message" id="login-error"></p>
        <button type="submit">Login</button>
        <p id="toggle-auth">Don't have an account? Register here.</p>
    </form>
    <form id="register-form" class="glass hidden">
        <h2>Register</h2>
        <input type="email" id="register-email" placeholder="Email" required>
        <input type="text" id="register-username" placeholder="Username" required>
        <div class="password-container">
            <input type="password" id="register-password" placeholder="Password" required>
            <span class="eye-icon" id="register-eye">&#128065;</span>
        </div>
        <p class="error-message" id="register-error"></p>
        <button type="submit">Register</button>
        <p id="toggle-auth">Already have an account? Login here.</p>
    </form>
</section>

<script type="module">
    // Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, orderBy, limit, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyAM6CRs7ahy4qdH1kblN-ZN25IFMReuUDU",
        authDomain: "flappy-india.firebaseapp.com",
        projectId: "flappy-india",
        storageBucket: "flappy-india.appspot.com",
        messagingSenderId: "256590287009",
        appId: "1:256590287009:web:7886c3015aee6fca1d20e0",
        measurementId: "G-QV4VZ6Q1CM"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Game Constants
    const GRAVITY = 0.5;
    const FLAP_STRENGTH = -10;
    const PILLAR_SPEED = 3;
    const PILLAR_GAP = 200; // Gap between top and bottom pillar
    const PILLAR_WIDTH = 80; // Assumed width based on image
    const PILLAR_SPACING = 300; // Distance between pairs
    const HITBOX_PADDING = 0.1; // 10% padding for hitbox shrinkage
    const NUM_PAIRS = 100; // 100 pairs, 200 pillars
    const BASE_WIDTH = 1920; // Assumed base for 16:9
    const BASE_HEIGHT = 1080;

    // Asset Paths
    const assets = {
        images: {
            bg: 'assets/images/bg.png',
            character: 'assets/images/character.png',
            up_piller: 'assets/images/up_piller.png',
            down_piller: 'assets/images/down_piller.png',
            popup: 'assets/images/popup.png',
            win: 'assets/images/win.png',
            logo: 'assets/images/logo.png'
        },
        audio: {
            bg: 'assets/audio/Bg.mp3',
            tap: 'assets/audio/Tap.mp3',
            popup: 'assets/audio/popup.mp3',
            win: 'assets/audio/win.mp3'
        }
    };

    // Global Variables
    let canvas, ctx;
    let player, pillars = [];
    let bgImage, characterImage, upPillerImage, downPillerImage;
    let bgAudio, tapAudio, popupAudio, winAudio;
    let score = 0;
    let isGameRunning = false;
    let isGuest = true;
    let userData = { bestScore: 0, totalScores: 0, scoreCount: 0, username: 'Guest' };
    let scaleFactor = 1;
    let requestId;
    let bgX = 0; // For scrolling background

    // Loading Progress
    let loadedAssets = 0;
    let totalAssets = Object.keys(assets.images).length + Object.keys(assets.audio).length;

    // Function to update loading progress
    function updateLoadingProgress() {
        loadedAssets++;
        const progress = (loadedAssets / totalAssets) * 100;
        document.getElementById('loading-progress').style.width = `${progress}%`;
        if (loadedAssets === totalAssets) {
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                showSection('game-section');
            }, 500);
        }
    }

    // Load Image Helper
    function loadImage(src) {
        const img = new Image();
        img.src = src;
        img.onload = updateLoadingProgress;
        return img;
    }

    // Load Audio Helper
    function loadAudio(src) {
        const audio = new Audio();
        audio.src = src;
        audio.onloadeddata = updateLoadingProgress;
        return audio;
    }

    // Preload Assets
    function preloadAssets() {
        bgImage = loadImage(assets.images.bg);
        characterImage = loadImage(assets.images.character);
        upPillerImage = loadImage(assets.images.up_piller);
        downPillerImage = loadImage(assets.images.down_piller);
        // Popup and win are for div backgrounds, no need to load as Image
        loadImage(assets.images.popup); // Still load for completeness
        loadImage(assets.images.win);
        loadImage(assets.images.logo);

        bgAudio = loadAudio(assets.audio.bg);
        tapAudio = loadAudio(assets.audio.tap);
        popupAudio = loadAudio(assets.audio.popup);
        winAudio = loadAudio(assets.audio.win);

        bgAudio.loop = true;
    }

    // Player Object
    class Player {
        constructor() {
            this.x = 100;
            this.y = BASE_HEIGHT / 2;
            this.velocity = 0;
            this.width = 0; // Set after image load
            this.height = 0;
            this.rotation = 0;
        }

        update() {
            this.velocity += GRAVITY;
            this.y += this.velocity;
            if (this.velocity > 0) {
                this.rotation = Math.min(this.velocity / 10, Math.PI / 4);
            } else {
                this.rotation = -Math.PI / 6;
            }
        }

        flap() {
            this.velocity = FLAP_STRENGTH;
            tapAudio.play();
            this.rotation = -Math.PI / 6;
        }

        getHitbox() {
            const paddingX = this.width * HITBOX_PADDING;
            const paddingY = this.height * HITBOX_PADDING;
            return {
                x: this.x + paddingX,
                y: this.y + paddingY,
                width: this.width - 2 * paddingX,
                height: this.height - 2 * paddingY
            };
        }
    }

    // Pillar Object
    class Pillar {
        constructor(x, y, isTop) {
            this.x = x;
            this.y = y;
            this.width = PILLAR_WIDTH;
            this.height = 0; // Set after image
            this.isTop = isTop;
            this.passed = false;
        }

        update() {
            this.x -= PILLAR_SPEED;
        }

        getHitbox() {
            const paddingX = this.width * HITBOX_PADDING;
            const paddingY = this.height * HITBOX_PADDING;
            return {
                x: this.x + paddingX,
                y: this.y + (this.isTop ? paddingY : 0),
                width: this.width - 2 * paddingX,
                height: this.height - (this.isTop ? paddingY : paddingY)
            };
        }
    }

    // Generate Pillars
    function generatePillars() {
        pillars = [];
        for (let i = 0; i < NUM_PAIRS; i++) {
            const gapY = Math.random() * (BASE_HEIGHT - 400) + 200; // Random gap position
            const topHeight = gapY - PILLAR_GAP / 2;
            const bottomY = gapY + PILLAR_GAP / 2;
            const bottomHeight = BASE_HEIGHT - bottomY;
            const x = BASE_WIDTH + i * PILLAR_SPACING;

            const topPillar = new Pillar(x, 0, true);
            topPillar.height = topHeight;
            const bottomPillar = new Pillar(x, bottomY, false);
            bottomPillar.height = bottomHeight;

            pillars.push(topPillar, bottomPillar);
        }
    }

    // Collision Detection
    function checkCollision() {
        const playerHitbox = player.getHitbox();
        if (player.y < 0 || player.y + player.height > BASE_HEIGHT) {
            return true;
        }
        for (let pillar of pillars) {
            const pillarHitbox = pillar.getHitbox();
            if (
                playerHitbox.x < pillarHitbox.x + pillarHitbox.width &&
                playerHitbox.x + playerHitbox.width > pillarHitbox.x &&
                playerHitbox.y < pillarHitbox.y + pillarHitbox.height &&
                playerHitbox.y + playerHitbox.height > pillarHitbox.y
            ) {
                return true;
            }
        }
        return false;
    }

    // Update Score
    function updateScore() {
        for (let pillar of pillars) {
            if (!pillar.passed && pillar.x + pillar.width < player.x) {
                pillar.passed = true;
                if (!pillar.isTop) { // Score per pair
                    score++;
                    document.getElementById('score-display').textContent = `Score: ${score}`;
                }
            }
        }
    }

    // Check Win
    function checkWin() {
        return score >= NUM_PAIRS;
    }

    // Game Loop
    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw Background (scrolling)
        ctx.drawImage(bgImage, bgX, 0, canvas.width, canvas.height);
        ctx.drawImage(bgImage, bgX + canvas.width, 0, canvas.width, canvas.height);
        bgX -= PILLAR_SPEED / 2;
        if (bgX <= -canvas.width) bgX = 0;

        // Update and Draw Player
        player.update();
        ctx.save();
        ctx.translate(player.x + player.width / 2, player.y + player.height / 2);
        ctx.rotate(player.rotation);
        ctx.drawImage(characterImage, -player.width / 2, -player.height / 2, player.width, player.height);
        ctx.restore();

        // Update and Draw Pillars
        for (let pillar of pillars) {
            pillar.update();
            const img = pillar.isTop ? upPillerImage : downPillerImage;
            ctx.drawImage(img, pillar.x, pillar.y, pillar.width, pillar.height);
        }

        // Remove passed pillars (optimization)
        if (pillars[0].x + pillars[0].width < 0) {
            pillars.shift();
            pillars.shift(); // Remove pair
        }

        updateScore();

        if (checkCollision()) {
            endGame(false);
        } else if (checkWin()) {
            endGame(true);
        } else {
            requestId = requestAnimationFrame(gameLoop);
        }
    }

    // Start Game
    function startGame() {
        if (isGameRunning) return;
        isGameRunning = true;
        score = 0;
        document.getElementById('score-display').textContent = `Score: 0`;
        player = new Player();
        generatePillars();
        bgAudio.play();
        hidePopups();
        gameLoop();
    }

    // End Game
    function endGame(isWin) {
        isGameRunning = false;
        cancelAnimationFrame(requestId);
        bgAudio.pause();
        bgAudio.currentTime = 0;
        if (isWin) {
            winAudio.play();
            showWinPopup();
        } else {
            popupAudio.play();
            showGameOverPopup();
        }
        if (!isGuest) {
            updateUserStats(score);
        }
    }

    // Show/Hide Popups
    function showGameOverPopup() {
        const popup = document.getElementById('game-over-popup');
        document.getElementById('current-score').textContent = `Current Score: ${score}`;
        document.getElementById('best-score').textContent = `Best Score: ${userData.bestScore}`;
        document.getElementById('average-score').textContent = `Average Score: ${(userData.totalScores / userData.scoreCount || 0).toFixed(2)}`;
        popup.style.display = 'flex';
    }

    function showWinPopup() {
        const popup = document.getElementById('win-popup');
        document.getElementById('win-current-score').textContent = `Final Score: ${score}`;
        document.getElementById('win-best-score').textContent = `Best Score: ${userData.bestScore}`;
        document.getElementById('win-average-score').textContent = `Average Score: ${(userData.totalScores / userData.scoreCount || 0).toFixed(2)}`;
        popup.style.display = 'flex';
    }

    function hidePopups() {
        document.getElementById('game-over-popup').style.display = 'none';
        document.getElementById('win-popup').style.display = 'none';
    }

    // Update User Stats
    async function updateUserStats(newScore) {
        if (newScore > userData.bestScore) {
            userData.bestScore = newScore;
        }
        userData.totalScores += newScore;
        userData.scoreCount++;
        const userRef = doc(db, 'users', auth.currentUser.uid);
        await updateDoc(userRef, {
            bestScore: userData.bestScore,
            totalScores: userData.totalScores,
            scoreCount: userData.scoreCount
        });
    }

    // Load User Data
    async function loadUserData() {
        if (isGuest) return;
        const userRef = doc(db, 'users', auth.currentUser.uid);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
            userData = userSnap.data();
        }
    }

    // Leaderboard
    function loadLeaderboard() {
        const leaderboardBody = document.getElementById('leaderboard-body');
        leaderboardBody.innerHTML = '';
        const q = query(collection(db, 'users'), orderBy('bestScore', 'desc'), limit(10));
        onSnapshot(q, (snapshot) => {
            leaderboardBody.innerHTML = '';
            snapshot.forEach((doc, index) => {
                const data = doc.data();
                const row = `<tr><td>\( {index + 1}</td><td> \){data.username}</td><td>${data.bestScore}</td></tr>`;
                leaderboardBody.innerHTML += row;
            });
        });
    }

    // Auth Functions
    async function registerUser(email, username, password) {
        try {
            // Check if username exists
            const usernameRef = doc(db, 'usernames', username);
            const usernameSnap = await getDoc(usernameRef);
            if (usernameSnap.exists()) {
                throw new Error('Username already taken');
            }

            // Create user
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const uid = userCredential.user.uid;

            // Save user data
            await setDoc(doc(db, 'users', uid), {
                username,
                email,
                bestScore: 0,
                totalScores: 0,
                scoreCount: 0
            });

            // Save username mapping
            await setDoc(usernameRef, { uid, email });

            return true;
        } catch (error) {
            document.getElementById('register-error').textContent = error.message;
            document.getElementById('register-error').style.display = 'block';
            return false;
        }
    }

    async function loginUser(username, password) {
        try {
            // Get email from username
            const usernameRef = doc(db, 'usernames', username);
            const usernameSnap = await getDoc(usernameRef);
            if (!usernameSnap.exists()) {
                throw new Error('Username not found');
            }
            const { email } = usernameSnap.data();

            // Login
            await signInWithEmailAndPassword(auth, email, password);
            return true;
        } catch (error) {
            document.getElementById('login-error').textContent = error.message;
            document.getElementById('login-error').style.display = 'block';
            return false;
        }
    }

    function logoutUser() {
        signOut(auth);
    }

    // Auth State Listener
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            isGuest = false;
            await loadUserData();
            document.getElementById('profile-username').textContent = `Welcome, ${userData.username}`;
            document.getElementById('profile-best').textContent = `Best Score: ${userData.bestScore}`;
            document.getElementById('profile-average').textContent = `Average Score: ${(userData.totalScores / userData.scoreCount || 0).toFixed(2)}`;
            document.getElementById('logout-btn').classList.remove('hidden');
            loadLeaderboard();
            showSection('profile-section');
        } else {
            isGuest = true;
            userData = { bestScore: 0, totalScores: 0, scoreCount: 0, username: 'Guest' };
            document.getElementById('profile-username').textContent = 'Welcome, Guest';
            document.getElementById('profile-best').textContent = 'Best Score: 0';
            document.getElementById('profile-average').textContent = 'Average Score: 0';
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('leaderboard-body').innerHTML = '<tr><td colspan="3">Login to view leaderboard</td></tr>';
            showSection('auth-section');
        }
    });

    // Show Section
    function showSection(sectionId) {
        document.getElementById('game-section').style.display = sectionId === 'game-section' ? 'flex' : 'none';
        document.getElementById('profile-section').style.display = sectionId === 'profile-section' ? 'flex' : 'none';
        document.getElementById('auth-section').style.display = sectionId === 'auth-section' ? 'flex' : 'none';
        if (sectionId === 'game-section') startGame();
    }

 // Resize Canvas
    function resizeCanvas() {
        const aspect = 16 / 9;
        let width = window.innerWidth;
        let height = window.innerHeight;
        if (width / height > aspect) {
            width = height * aspect;
        } else {
            height = width / aspect;
        }
        canvas.width = width;
        canvas.height = height;
        scaleFactor = width / BASE_WIDTH;

        // Scale assets dynamically
        player.width = characterImage.naturalWidth * scaleFactor;
        player.height = characterImage.naturalHeight * scaleFactor;
        PILLAR_WIDTH = upPillerImage.naturalWidth * scaleFactor;
        for (let pillar of pillars) {
            pillar.width = PILLAR_WIDTH;
            pillar.height = pillar.isTop ? pillar.height * scaleFactor : pillar.height * scaleFactor;
        }
    }

    // Event Listeners
    function initEvents() {
        // Resize
        window.addEventListener('resize', resizeCanvas);

        // Flap
        window.addEventListener('keydown', (e) => {
            if (e.key === ' ' && isGameRunning) player.flap();
        });
        canvas.addEventListener('touchstart', () => {
            if (isGameRunning) player.flap();
        });

        // Nav Buttons
        document.getElementById('game-btn').addEventListener('click', () => showSection('game-section'));
        document.getElementById('profile-btn').addEventListener('click', () => {
            if (isGuest) {
                showSection('auth-section');
            } else {
                showSection('profile-section');
            }
        });

        // Restart
        document.getElementById('restart-btn').addEventListener('click', startGame);
        document.getElementById('win-restart-btn').addEventListener('click', startGame);

        // Auth Toggle
        const toggleAuth = document.querySelectorAll('#toggle-auth');
        toggleAuth.forEach(el => {
            el.addEventListener('click', () => {
                document.getElementById('login-form').classList.toggle('hidden');
                document.getElementById('register-form').classList.toggle('hidden');
            });
        });

        // Password Eye
        document.getElementById('login-eye').addEventListener('click', () => {
            const pass = document.getElementById('login-password');
            pass.type = pass.type === 'password' ? 'text' : 'password';
        });
        document.getElementById('register-eye').addEventListener('click', () => {
            const pass = document.getElementById('register-password');
            pass.type = pass.type === 'password' ? 'text' : 'password';
        });

        // Login Form
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            if (await loginUser(username, password)) {
                // Success, auth state will handle
            }
        });

        // Register Form
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            if (await registerUser(email, username, password)) {
                // Success, auth state will handle
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', logoutUser);
    }

    // Init Game
    function init() {
        canvas = document.getElementById('game-canvas');
        ctx = canvas.getContext('2d');
        preloadAssets();
        resizeCanvas();
        initEvents();

        // Set initial sizes after images load (but since onload, assume ready)
        // For simplicity, set here assuming loaded
        player = new Player();
        player.width = characterImage.naturalWidth;
        player.height = characterImage.naturalHeight;
    }

    // Start Init
    init();
</script>
